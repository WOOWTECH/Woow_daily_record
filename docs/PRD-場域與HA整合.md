# PRDï¼šå¤šå ´åŸŸç®¡ç†ç³»çµ±

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯
æ ¹æ“šæˆªåœ–æ‰€ç¤ºçš„ Home Assistant æ•´åˆéœ€æ±‚ï¼Œä½¿ç”¨è€…éœ€è¦èƒ½å¤ ç®¡ç†å¤šå€‹å ´åŸŸï¼ˆå¦‚ï¼šå®¶åº­ã€è¾¦å…¬å®¤ï¼‰ï¼Œæ¯å€‹å ´åŸŸå¯ä»¥é€£æŽ¥ç¨ç«‹çš„ Home Assistant å¯¦ä¾‹ã€‚ç³»çµ±éœ€è¦æ”¯æ´å ´åŸŸåˆ‡æ›ã€æˆå“¡ç®¡ç†ã€ä»¥åŠæ–°ç”¨æˆ¶å¼•å°Žæµç¨‹ã€‚

### 1.2 ç›®æ¨™
- æ”¯æ´ä½¿ç”¨è€…æ“æœ‰/ç®¡ç†å¤šå€‹å ´åŸŸ
- å¯¦ç¾å ´åŸŸåˆ‡æ›åŠŸèƒ½
- å»ºç«‹æ–°ç”¨æˆ¶å¼•å°Žæµç¨‹ï¼ˆå»ºç«‹ç¬¬ä¸€å€‹å ´åŸŸï¼‰
- æ•´åˆ Home Assistant é€£ç·šè¨­å®š
- å®Œå–„è§’è‰²æ¬Šé™ç®¡ç†

---

## 2. ä½¿ç”¨è€…è§’è‰²

### 2.1 è§’è‰²å®šç¾©

| è§’è‰² | èªªæ˜Ž | æ¬Šé™ç¯„åœ |
|------|------|----------|
| **æ“æœ‰è€… (Owner)** | å ´åŸŸå‰µå»ºè€…ï¼Œæ¯å€‹å ´åŸŸåƒ…ä¸€äºº | å®Œæ•´æŽ§åˆ¶æ¬Šï¼ŒåŒ…å«åˆªé™¤å ´åŸŸ |
| **ç®¡ç†å“¡ (Admin)** | è¢«æŽˆæ¬Šçš„ç®¡ç†è€… | ç®¡ç†æˆå“¡ã€ç·¨è¼¯å ´åŸŸè¨­å®š |
| **æˆå“¡ (Member)** | ä¸€èˆ¬ä½¿ç”¨è€… | ä¾æ“šé é¢æ¬Šé™è¨­å®šå­˜å– |

### 2.2 æ¬Šé™å°ç…§è¡¨

| åŠŸèƒ½ | Owner | Admin | Member |
|------|-------|-------|--------|
| æª¢è¦–å ´åŸŸè³‡è¨Š | âœ… | âœ… | âœ… |
| ç·¨è¼¯å ´åŸŸè¨­å®š | âœ… | âœ… | âŒ |
| ç®¡ç† HA é€£ç·š | âœ… | âœ… | âŒ |
| é‚€è«‹æˆå“¡ | âœ… | âœ… | âŒ |
| ç§»é™¤æˆå“¡ | âœ… | âœ… | âŒ |
| ä¿®æ”¹æˆå“¡æ¬Šé™ | âœ… | âœ… | âŒ |
| åˆªé™¤å ´åŸŸ | âœ… | âŒ | âŒ |
| è½‰ç§»æ“æœ‰æ¬Š | âœ… | âŒ | âŒ |

---

## 3. åŠŸèƒ½éœ€æ±‚

### 3.1 å ´åŸŸåˆ‡æ›å™¨ (Site Switcher)

**ä½ç½®**ï¼šå´é‚Šæ¬„ä¸Šæ–¹ï¼ˆLogo ä¸‹æ–¹ï¼‰

**é¡¯ç¤ºå…§å®¹**ï¼š
- ç•¶å‰å ´åŸŸåç¨±
- ä½¿ç”¨è€…åœ¨æ­¤å ´åŸŸçš„è§’è‰²
- ä¸‹æ‹‰é¸å–®é¡¯ç¤ºæ‰€æœ‰å¯å­˜å–çš„å ´åŸŸ

**æ“ä½œ**ï¼š
- é»žæ“Šåˆ‡æ›è‡³å…¶ä»–å ´åŸŸ
- ã€Œå»ºç«‹æ–°å ´åŸŸã€å…¥å£
- å ´åŸŸåˆ‡æ›å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ðŸ  æˆ‘çš„å®¶          â”‚
â”‚  æ“æœ‰è€…             â”‚
â”‚  â–¼                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ æˆ‘çš„å®¶ (æ“æœ‰è€…)  â”‚
â”‚    è¾¦å…¬å®¤ (æˆå“¡)    â”‚
â”‚    çˆ¶æ¯å®¶ (ç®¡ç†å“¡)  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ï¼‹ å»ºç«‹æ–°å ´åŸŸ      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ–°ç”¨æˆ¶å¼•å°Žæµç¨‹ (Onboarding)

**è§¸ç™¼æ¢ä»¶**ï¼š
- æ–°è¨»å†Šç”¨æˆ¶ç™»å…¥
- ç”¨æˆ¶æ²’æœ‰ä»»ä½•å ´åŸŸæˆå“¡è³‡æ ¼

**æµç¨‹æ­¥é©Ÿ**ï¼š

```
Step 1: æ­¡è¿Žç•«é¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     æ­¡è¿Žä½¿ç”¨ Woowtech!      â”‚
â”‚                             â”‚
â”‚  è®“æˆ‘å€‘é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹   â”‚
â”‚  å ´åŸŸä¾†è¨˜éŒ„ç”Ÿæ´»å§           â”‚
â”‚                             â”‚
â”‚      [é–‹å§‹è¨­å®š â†’]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: å»ºç«‹å ´åŸŸ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å»ºç«‹æ‚¨çš„å ´åŸŸ            â”‚
â”‚                             â”‚
â”‚  å ´åŸŸåç¨±                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ æˆ‘çš„å®¶              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚
â”‚  æè¿°ï¼ˆé¸å¡«ï¼‰               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ è¨˜éŒ„å®¶åº­æ—¥å¸¸ç”Ÿæ´»    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                             â”‚
â”‚  [â† è¿”å›ž]    [å»ºç«‹å ´åŸŸ â†’]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: å®Œæˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        âœ“ è¨­å®šå®Œæˆï¼         â”‚
â”‚                             â”‚
â”‚  æ‚¨çš„å ´åŸŸã€Œæˆ‘çš„å®¶ã€å·²å»ºç«‹   â”‚
â”‚                             â”‚
â”‚  æŽ¥ä¸‹ä¾†æ‚¨å¯ä»¥ï¼š             â”‚
â”‚  â€¢ é‚€è«‹å®¶äººåŠ å…¥             â”‚
â”‚  â€¢ é€£æŽ¥ Home Assistant      â”‚
â”‚  â€¢ é–‹å§‹è¨˜éŒ„ç”Ÿæ´»             â”‚
â”‚                             â”‚
â”‚      [é€²å…¥å ´åŸŸ â†’]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å ´åŸŸç®¡ç†

#### 3.3.1 å»ºç«‹å ´åŸŸ

**å…¥å£**ï¼š
- å ´åŸŸåˆ‡æ›å™¨ä¸‹æ‹‰é¸å–®
- è¨­å®šé é¢

**è¡¨å–®æ¬„ä½**ï¼š
- å ´åŸŸåç¨±ï¼ˆå¿…å¡«ï¼‰
- æè¿°ï¼ˆé¸å¡«ï¼‰

**å»ºç«‹å¾Œ**ï¼š
- è‡ªå‹•æˆç‚ºè©²å ´åŸŸæ“æœ‰è€…
- è‡ªå‹•åˆ‡æ›è‡³æ–°å ´åŸŸ
- è‡ªå‹•å»ºç«‹é è¨­æ¬Šé™è¨­å®š

#### 3.3.2 ç·¨è¼¯å ´åŸŸè¨­å®š

**å¯ç·¨è¼¯é …ç›®**ï¼ˆä¾æ“šæˆªåœ–ï¼‰ï¼š
- å ´åŸŸåç¨±
- å¤–è§€è¨­å®šï¼ˆä¸»é¡Œã€å¼·èª¿è‰²ï¼‰
- èªžè¨€è¨­å®š
- åœ°å€è¨­å®šï¼ˆæ™‚å€ã€å–®ä½ï¼‰
- Home Assistant æ•´åˆ
  - HA URLï¼ˆè¼¸å…¥ https://... æ ¼å¼ï¼Œç³»çµ±è‡ªå‹•è½‰æ›ç‚º WebSocketï¼‰
  - API Token
  - é€£ç·šç‹€æ…‹é¡¯ç¤º
  - é‡æ–°é€£ç·šæŒ‰éˆ•

#### 3.3.3 åˆªé™¤å ´åŸŸ

**é™åˆ¶**ï¼š
- åƒ…æ“æœ‰è€…å¯åŸ·è¡Œ
- éœ€äºŒæ¬¡ç¢ºèªï¼ˆè¼¸å…¥å ´åŸŸåç¨±ï¼‰

**åˆªé™¤å½±éŸ¿**ï¼š
- ç§»é™¤æ‰€æœ‰æˆå“¡é—œè¯
- åˆªé™¤æ‰€æœ‰å ´åŸŸè³‡æ–™
- è‹¥ç‚ºç”¨æˆ¶å”¯ä¸€å ´åŸŸï¼Œå¼•å°Žå»ºç«‹æ–°å ´åŸŸ

### 3.4 æˆå“¡ç®¡ç†

#### 3.4.1 é‚€è«‹æˆå“¡

**æµç¨‹**ï¼š
1. è¼¸å…¥è¢«é‚€è«‹è€… Email
2. é¸æ“‡è§’è‰²ï¼ˆAdmin / Memberï¼‰
3. ç™¼é€é‚€è«‹
4. ç”Ÿæˆé‚€è«‹é€£çµï¼ˆå¯è¤‡è£½åˆ†äº«ï¼‰

**é‚€è«‹è¨­å®š**ï¼š
- Adminï¼šé è¨­å…¨éƒ¨é é¢ Full æ¬Šé™
- Memberï¼šé è¨­å…¨éƒ¨é é¢ Close æ¬Šé™ï¼ˆå¾…ç®¡ç†å“¡é–‹å•Ÿï¼‰

#### 3.4.2 æ¬Šé™çŸ©é™£

**é é¢æ¸…å–®**ï¼š
- é¦–é  (home)
- å¥åº· (health)
- è²¡å‹™ (finance)
- ç”Ÿç”¢åŠ› (productivity)
- è¨­å‚™ (devices)
- è¨­å®š (settings)

**æ¬Šé™ç­‰ç´š**ï¼š
| ç­‰ç´š | èªªæ˜Ž |
|------|------|
| Close | é é¢éš±è—ï¼Œç„¡æ³•å­˜å– |
| View | åƒ…æª¢è¦–ï¼Œä¸å¯ç·¨è¼¯ |
| Limited | å¯æ–°å¢ž/ç·¨è¼¯ç´€éŒ„ï¼Œä¸å¯ç®¡ç†é¡žåˆ¥/å¸³æˆ¶ |
| Full | å®Œæ•´æ¬Šé™ï¼ŒåŒ…å«ç®¡ç†åŠŸèƒ½ |

---

## 4. è³‡æ–™çµæ§‹

### 4.1 è³‡æ–™è¡¨é—œä¿‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  profiles   â”‚     â”‚ household_membersâ”‚     â”‚   households    â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ id (PK)     â”‚â”€â”€â”  â”‚ id (PK)          â”‚  â”Œâ”€â”€â”‚ id (PK)         â”‚
â”‚ name        â”‚  â””â”€>â”‚ user_id (FK)     â”‚  â”‚  â”‚ owner_id (FK)   â”‚
â”‚ avatar_url  â”‚     â”‚ household_id (FK)â”‚<â”€â”˜  â”‚ name            â”‚
â”‚ ...         â”‚     â”‚ role             â”‚     â”‚ ha_url          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ status           â”‚     â”‚ ha_token        â”‚
                    â”‚ joined_at        â”‚     â”‚ ...             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ page_permissions â”‚
                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
                    â”‚ id (PK)          â”‚
                    â”‚ household_member â”‚
                    â”‚ _id (FK)         â”‚
                    â”‚ page             â”‚
                    â”‚ access_level     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 households è¡¨æ›´æ–°

```sql
ALTER TABLE households ADD COLUMN IF NOT EXISTS description TEXT;
ALTER TABLE households ADD COLUMN IF NOT EXISTS deleted_at TIMESTAMPTZ;
```

### 4.3 invitations è¡¨æ›´æ–°

```sql
-- ç§»é™¤ default_access_levelï¼Œæ”¹ç”¨ role
ALTER TABLE invitations DROP COLUMN IF EXISTS default_access_level;
ALTER TABLE invitations ADD COLUMN IF NOT EXISTS role TEXT
  CHECK (role IN ('admin', 'member')) DEFAULT 'member';
```

---

## 5. API è¨­è¨ˆ

### 5.1 å ´åŸŸç›¸é—œ

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜Ž |
|------|------|------|
| GET | /api/sites | å–å¾—ä½¿ç”¨è€…æ‰€æœ‰å ´åŸŸ |
| POST | /api/sites | å»ºç«‹æ–°å ´åŸŸ |
| GET | /api/sites/:id | å–å¾—å ´åŸŸè©³æƒ… |
| PATCH | /api/sites/:id | æ›´æ–°å ´åŸŸè¨­å®š |
| DELETE | /api/sites/:id | åˆªé™¤å ´åŸŸï¼ˆåƒ…æ“æœ‰è€…ï¼‰ |
| POST | /api/sites/:id/transfer | è½‰ç§»æ“æœ‰æ¬Š |

### 5.2 æˆå“¡ç›¸é—œ

| æ–¹æ³• | è·¯å¾‘ | èªªæ˜Ž |
|------|------|------|
| GET | /api/sites/:id/members | å–å¾—å ´åŸŸæˆå“¡ |
| POST | /api/sites/:id/invite | ç™¼é€é‚€è«‹ |
| DELETE | /api/sites/:id/members/:memberId | ç§»é™¤æˆå“¡ |
| PATCH | /api/sites/:id/members/:memberId/permissions | æ›´æ–°æˆå“¡æ¬Šé™ |

---

## 6. UI/UX è¨­è¨ˆè¦é»ž

### 6.1 å ´åŸŸåˆ‡æ›é«”é©—
- åˆ‡æ›æ™‚é¡¯ç¤ºè¼‰å…¥æŒ‡ç¤ºå™¨
- ä¿æŒç•¶å‰é é¢è·¯å¾‘ï¼ˆå¦‚åœ¨ /finance åˆ‡æ›å ´åŸŸå¾Œä»åœ¨ /financeï¼‰
- è‹¥æ–°å ´åŸŸç„¡è©²é é¢æ¬Šé™ï¼Œè‡ªå‹•å°Žå‘é¦–é 

### 6.2 ç©ºç‹€æ…‹è™•ç†
- ç„¡å ´åŸŸï¼šé¡¯ç¤ºå¼•å°Žå»ºç«‹æµç¨‹
- å–®ä¸€å ´åŸŸï¼šå ´åŸŸåˆ‡æ›å™¨ç°¡åŒ–é¡¯ç¤º
- å¤šå ´åŸŸï¼šå®Œæ•´ä¸‹æ‹‰é¸å–®

### 6.3 éŒ¯èª¤è™•ç†
- HA é€£ç·šå¤±æ•—ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯èˆ‡é‡è©¦æŒ‰éˆ•
- æ¬Šé™ä¸è¶³ï¼šé¡¯ç¤ºå‹å–„æç¤ºï¼Œå¼•å°Žè¯ç¹«ç®¡ç†å“¡
- å ´åŸŸä¸å­˜åœ¨ï¼šè‡ªå‹•åˆ‡æ›è‡³å…¶ä»–å¯ç”¨å ´åŸŸ

---

## 7. å¯¦ä½œéšŽæ®µ

### Phase 1ï¼šåŸºç¤Žæž¶æ§‹ï¼ˆå·²å®Œæˆï¼‰
- [x] è³‡æ–™åº« migration
- [x] Sites store å’Œ hooks
- [x] SiteSwitcher çµ„ä»¶
- [x] æ¬Šé™ç³»çµ±æ›´æ–°

### Phase 2ï¼šæ–°ç”¨æˆ¶å¼•å°Ž
- [ ] Onboarding é é¢çµ„ä»¶
- [ ] é¦–æ¬¡ç™»å…¥æª¢æ¸¬é‚è¼¯
- [ ] å»ºç«‹å ´åŸŸæµç¨‹å„ªåŒ–

### Phase 3ï¼šå ´åŸŸç®¡ç†å®Œå–„
- [ ] åˆªé™¤å ´åŸŸåŠŸèƒ½
- [ ] è½‰ç§»æ“æœ‰æ¬ŠåŠŸèƒ½
- [ ] å ´åŸŸæè¿°æ¬„ä½

### Phase 4ï¼šHA æ•´åˆå„ªåŒ–
- [ ] é€£ç·šç‹€æ…‹å³æ™‚ç›£æŽ§
- [ ] è‡ªå‹•é‡é€£æ©Ÿåˆ¶
- [ ] è¨­å‚™åŒæ­¥åŠŸèƒ½

---

## 8. é©—æ”¶æ¨™æº–

### 8.1 åŠŸèƒ½é©—æ”¶
- [ ] æ–°ç”¨æˆ¶å¯å®Œæˆå¼•å°Žæµç¨‹å»ºç«‹å ´åŸŸ
- [ ] ç”¨æˆ¶å¯åœ¨å¤šå ´åŸŸé–“åˆ‡æ›
- [ ] Owner å¯åˆªé™¤è‡ªå·±çš„å ´åŸŸ
- [ ] æ¬Šé™ç³»çµ±æ­£ç¢ºæŽ§åˆ¶é é¢å­˜å–
- [ ] HA é€£ç·šè¨­å®šå¯æ­£å¸¸å„²å­˜èˆ‡é€£æŽ¥

### 8.2 æ•ˆèƒ½æŒ‡æ¨™
- å ´åŸŸåˆ‡æ›éŸ¿æ‡‰æ™‚é–“ < 500ms
- é é¢è¼‰å…¥æ™‚é–“ < 2s
- HA WebSocket é€£ç·šå»ºç«‹ < 3s

### 8.3 å®‰å…¨æ€§
- RLS ç­–ç•¥æ­£ç¢ºéš”é›¢å ´åŸŸè³‡æ–™
- åƒ… Owner å¯åŸ·è¡Œåˆªé™¤æ“ä½œ
- API Token åŠ å¯†å„²å­˜
