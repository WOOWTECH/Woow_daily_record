# PRD: å¤šå ´åŸŸæ¬Šé™ç®¡ç†ç³»çµ±

**ç‰ˆæœ¬:** 1.0
**æ—¥æœŸ:** 2026-02-03
**ç‹€æ…‹:** è¦åŠƒä¸­

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯
ç›®å‰ç³»çµ±ä½¿ç”¨ã€Œç¶²ç«™ã€(website) è¡“èªï¼Œéœ€æ›´åç‚ºã€Œå ´åŸŸã€(site/field)ã€‚åŒæ™‚éœ€è¦æ”¯æ´å¤šå ´åŸŸæ¶æ§‹ï¼Œè®“æ¯å€‹ä½¿ç”¨è€…å¯ä»¥æ“æœ‰æˆ–åƒèˆ‡å¤šå€‹å ´åŸŸï¼Œæ¯å€‹å ´åŸŸæœ‰ç¨ç«‹çš„æˆå“¡å’Œæ¬Šé™ç®¡ç†ã€‚

### 1.2 ç›®æ¨™
- å°‡ã€Œç¶²ç«™ã€æ›´åç‚ºã€Œå ´åŸŸã€
- æ”¯æ´å¤šå ´åŸŸï¼šæ¯å€‹ä½¿ç”¨è€…å¯å»ºç«‹/æ“æœ‰å¤šå€‹å ´åŸŸ
- ç´°ç·»çš„æ¬Šé™ç®¡ç†ï¼šæ¯å€‹é é¢ Ã— æ¯å€‹æˆå“¡ = ç¨ç«‹æ¬Šé™è¨­å®š
- ç°¡åŒ–çš„é‚€è«‹æµç¨‹ï¼šç®¡ç†å“¡/ä½¿ç”¨è€…é è¨­æ¬Šé™å·®ç•°åŒ–

---

## 2. è¡“èªå®šç¾©

| èˆŠè¡“èª | æ–°è¡“èª | è‹±æ–‡ | èªªæ˜ |
|--------|--------|------|------|
| ç¶²ç«™ | å ´åŸŸ | Site / Field | ä¸€å€‹ç¨ç«‹çš„å®¶åº­/çµ„ç¹”å–®ä½ |
| ç¶²ç«™æ“æœ‰è€… | å ´åŸŸæ“æœ‰è€… | Owner | å ´åŸŸçš„å‰µå»ºè€…ï¼Œæ“æœ‰æœ€é«˜æ¬Šé™ |
| - | ç®¡ç†å“¡ | Admin | å¯ç®¡ç†æˆå“¡å’Œå¤§éƒ¨åˆ†è¨­å®š |
| - | ä½¿ç”¨è€… | User/Member | æ™®é€šæˆå“¡ï¼Œæ¬Šé™ç”±ç®¡ç†å“¡è¨­å®š |

---

## 3. å ´åŸŸçµæ§‹

### 3.1 å ´åŸŸèˆ‡ä½¿ç”¨è€…é—œä¿‚

```
ä½¿ç”¨è€… A â”€â”¬â”€ æ“æœ‰è€… â”€â”€â†’ å ´åŸŸ 1 (æˆ‘çš„å®¶)
          â”œâ”€ æ“æœ‰è€… â”€â”€â†’ å ´åŸŸ 2 (è¾¦å…¬å®¤)
          â””â”€ æˆå“¡   â”€â”€â†’ å ´åŸŸ 3 (çˆ¸åª½å®¶)

ä½¿ç”¨è€… B â”€â”¬â”€ æ“æœ‰è€… â”€â”€â†’ å ´åŸŸ 3 (çˆ¸åª½å®¶)
          â””â”€ æˆå“¡   â”€â”€â†’ å ´åŸŸ 1 (æˆ‘çš„å®¶)
```

### 3.2 è§’è‰²å®šç¾©

| è§’è‰² | èªªæ˜ | æ•¸é‡é™åˆ¶ |
|------|------|----------|
| **owner** (æ“æœ‰è€…) | å ´åŸŸå‰µå»ºè€…ï¼Œæœ€é«˜æ¬Šé™ï¼Œå¯åˆªé™¤å ´åŸŸ | æ¯å ´åŸŸé™ 1 äºº |
| **admin** (ç®¡ç†å“¡) | å¯é‚€è«‹/ç§»é™¤æˆå“¡ã€ç®¡ç†æ¬Šé™ã€ç·¨è¼¯å ´åŸŸè¨­å®š | ä¸é™ |
| **member** (ä½¿ç”¨è€…) | æ¬Šé™ç”±ç®¡ç†å“¡è¨­å®šï¼Œé è¨­å…¨é—œ | ä¸é™ |

---

## 4. æ¬Šé™ç³»çµ±è¨­è¨ˆ

### 4.1 é é¢æ¸…å–®

ç›®å‰å´é‚Šæ¬„çš„åŠŸèƒ½é é¢ï¼ˆéœ€è¦æ¬Šé™æ§åˆ¶ï¼‰ï¼š

| é é¢ ID | é é¢åç¨± | è·¯ç”± | èªªæ˜ |
|---------|----------|------|------|
| `home` | é¦–é  | `/` | å„€è¡¨æ¿ç¸½è¦½ |
| `health` | å¥åº·ç´€éŒ„ | `/health/*` | å®¶åº­å¥åº·è¿½è¹¤ |
| `finance` | è²¡å‹™ç´€éŒ„ | `/finance/*` | æ”¶æ”¯è¨˜å¸³ |
| `productivity` | ç”Ÿç”¢åŠ› | `/productivity/*` | ä»»å‹™/ç­†è¨˜/æ—¥æ›† |
| `devices` | è¨­å‚™ç®¡ç† | `/devices/*` | å®¶é›»/è¨­å‚™è³‡è¨Š |
| `settings` | è¨­å®š | `/settings/*` | å ´åŸŸè¨­å®šï¼ˆåƒ… owner/adminï¼‰ |

### 4.2 æ¬Šé™ç­‰ç´š

| ç­‰ç´š | ä»£ç¢¼ | åœ–ç¤º | èªªæ˜ |
|------|------|------|------|
| **é—œé–‰** | `close` | ğŸš« | é é¢ä¸é¡¯ç¤ºï¼Œç„¡æ³•å­˜å– |
| **æª¢è¦–** | `view` | ğŸ‘ | åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½æ–°å¢/ç·¨è¼¯/åˆªé™¤ |
| **æœ‰é™** | `limited` | âœï¸ | å¯æ–°å¢/ç·¨è¼¯ç´€éŒ„ï¼Œä½†ä¸èƒ½ç®¡ç†é¡åˆ¥/å¸³æˆ¶ç­‰è¨­å®š |
| **ç·¨è¼¯** | `full` | â­ | å®Œæ•´æ¬Šé™ï¼ŒåŒ…å«ç®¡ç†é¡åˆ¥/å¸³æˆ¶/æˆå“¡ç­‰ |

### 4.3 æ¬Šé™çŸ©é™£ç¯„ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆå“¡æ¬Šé™ç®¡ç†                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æˆå“¡     â”‚ ğŸ é¦–é  â”‚ ğŸ¥å¥åº·   â”‚ ğŸ’°è²¡å‹™   â”‚ ğŸ“‹ç”Ÿç”¢åŠ› â”‚ ğŸ“±è¨­å‚™   â”‚ âš™ï¸è¨­å®š     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—å­Ÿç·¯   â”‚   â­   â”‚    â­    â”‚    â­    â”‚    â­    â”‚    â­    â”‚     â­      â”‚
â”‚ (owner)  â”‚  ç·¨è¼¯  â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚    ç·¨è¼¯     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å°æ˜     â”‚   â­   â”‚    â­    â”‚    â­    â”‚    â­    â”‚    â­    â”‚     âœï¸      â”‚
â”‚ (admin)  â”‚  ç·¨è¼¯  â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚   ç·¨è¼¯   â”‚    æœ‰é™     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å°è¯     â”‚   ğŸ‘   â”‚    ğŸš«    â”‚    âœï¸    â”‚    ğŸ‘    â”‚    ğŸš«    â”‚     ğŸš«      â”‚
â”‚ (member) â”‚  æª¢è¦–  â”‚   é—œé–‰   â”‚   æœ‰é™   â”‚   æª¢è¦–   â”‚   é—œé–‰   â”‚    é—œé–‰     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.4 ã€Œæœ‰é™ã€æ¬Šé™çš„å…·é«”é™åˆ¶

| é é¢ | å¯ä»¥åš | ä¸èƒ½åš |
|------|--------|--------|
| **å¥åº·ç´€éŒ„** | æ–°å¢/ç·¨è¼¯å¥åº·è¨˜éŒ„ | ç®¡ç†æ¸¬é‡é¡å‹ã€åˆªé™¤è¨˜éŒ„ |
| **è²¡å‹™ç´€éŒ„** | æ–°å¢/ç·¨è¼¯æ”¶æ”¯è¨˜éŒ„ | ç®¡ç†å¸³æˆ¶ã€ç®¡ç†é¡åˆ¥ã€åˆªé™¤è¨˜éŒ„ |
| **ç”Ÿç”¢åŠ›** | æ–°å¢/ç·¨è¼¯ä»»å‹™/ç­†è¨˜ | ç®¡ç†æ—¥æ›†é¡åˆ¥ã€åˆªé™¤ä»–äººä»»å‹™ |
| **è¨­å‚™ç®¡ç†** | æ–°å¢/ç·¨è¼¯è¨­å‚™è³‡è¨Š | åˆªé™¤è¨­å‚™ |
| **è¨­å®š** | ç·¨è¼¯å€‹äººè³‡æ–™ | ç®¡ç†å ´åŸŸè¨­å®šã€ç®¡ç†æˆå“¡ |

---

## 5. é‚€è«‹æµç¨‹

### 5.1 é‚€è«‹æˆå“¡å°è©±æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é‚€è«‹æˆå“¡                      â”‚
â”‚   ç™¼é€é‚€è«‹åŠ å…¥æ‚¨çš„å ´åŸŸ                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  é›»å­éƒµä»¶åœ°å€                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ name@example.com               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                        â”‚
â”‚  æˆå“¡è§’è‰²                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ğŸ‘‘ ç®¡ç†å“¡    â”‚ â”‚ ğŸ‘¤ ä½¿ç”¨è€…    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                        â”‚
â”‚  é è¨­å­˜å–ç­‰ç´š                           â”‚
â”‚  åˆå§‹å¥—ç”¨æ–¼æ‰€æœ‰é é¢ï¼ŒåŠ å…¥å¾Œå¯é€é è‡ªè¨‚ã€‚   â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ğŸ‘ æª¢è¦– â”‚ â”‚âœï¸ æœ‰é™ â”‚ â”‚â­ ç·¨è¼¯ â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          ç™¼é€é‚€è«‹               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            å–æ¶ˆ                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 é è¨­æ¬Šé™è¦å‰‡

| è§’è‰² | é è¨­æ¬Šé™ | èªªæ˜ |
|------|----------|------|
| **ç®¡ç†å“¡** | æ‰€æœ‰é é¢ = `full` (ç·¨è¼¯) | ç®¡ç†å“¡éœ€è¦å®Œæ•´æ¬Šé™ä¾†ç®¡ç†å ´åŸŸ |
| **ä½¿ç”¨è€…** | æ‰€æœ‰é é¢ = `close` (é—œé–‰) | ç­‰å¾…ç®¡ç†å“¡é€ä¸€é–‹å•Ÿéœ€è¦çš„æ¬Šé™ |

### 5.3 é‚€è«‹ç‹€æ…‹

| ç‹€æ…‹ | èªªæ˜ |
|------|------|
| `pending` | é‚€è«‹å·²ç™¼é€ï¼Œç­‰å¾…æ¥å— |
| `accepted` | å·²æ¥å—é‚€è«‹ |
| `expired` | é‚€è«‹å·²éæœŸï¼ˆ7å¤©ï¼‰ |
| `cancelled` | é‚€è«‹å·²å–æ¶ˆ |

---

## 6. å ´åŸŸåˆ‡æ›å™¨

### 6.1 ä½ç½®
- æ¡Œé¢ç‰ˆï¼šå´é‚Šæ¬„é ‚éƒ¨ Logo ä¸‹æ–¹
- æ‰‹æ©Ÿç‰ˆï¼šåº•éƒ¨å°è¦½åˆ—ä¸Šæ–¹æˆ–æ¼¢å ¡é¸å–®å…§

### 6.2 UI è¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  æˆ‘çš„å®¶              â–¼    â”‚  â† ç•¶å‰å ´åŸŸ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“ é»æ“Šå±•é–‹
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ  æˆ‘çš„å®¶           âœ“ æ“æœ‰è€…â”‚  â† ç•¶å‰é¸æ“‡
â”‚ ğŸ¢ è¾¦å…¬å®¤             æ“æœ‰è€…â”‚
â”‚ ğŸ¡ çˆ¸åª½å®¶              æˆå“¡ â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚ â• å»ºç«‹æ–°å ´åŸŸ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. è³‡æ–™åº«è¨­è¨ˆ

### 7.1 ç¾æœ‰è¡¨æ ¼ä¿®æ”¹

#### `households` è¡¨ï¼ˆæ›´åæ¦‚å¿µç‚º sites/å ´åŸŸï¼‰
ç„¡éœ€ä¿®æ”¹è¡¨åï¼Œä½† UI é¡¯ç¤ºæ”¹ç‚ºã€Œå ´åŸŸã€

#### `household_members` è¡¨
å·²æœ‰æ¬„ä½ï¼š
- `role`: `owner | admin | member | viewer`
- `status`: `pending | active | rejected | removed`

### 7.2 æ›´æ–° `page_permissions` è¡¨

```sql
-- æ–°å¢ home å’Œ settings é é¢
ALTER TABLE page_permissions
DROP CONSTRAINT IF EXISTS page_permissions_page_check;

ALTER TABLE page_permissions
ADD CONSTRAINT page_permissions_page_check
CHECK (page IN ('home', 'health', 'finance', 'productivity', 'devices', 'settings'));

-- æ›´æ–°æ¬Šé™ç­‰ç´šï¼ˆlimited å–ä»£ controlï¼‰
ALTER TABLE page_permissions
DROP CONSTRAINT IF EXISTS page_permissions_access_level_check;

ALTER TABLE page_permissions
ADD CONSTRAINT page_permissions_access_level_check
CHECK (access_level IN ('close', 'view', 'limited', 'full'));
```

### 7.3 æ–°å¢è§¸ç™¼å™¨ï¼šé‚€è«‹æˆå“¡æ™‚è‡ªå‹•å»ºç«‹æ¬Šé™

```sql
-- ç•¶ household_members æ–°å¢æ™‚ï¼Œè‡ªå‹•å»ºç«‹ page_permissions
CREATE OR REPLACE FUNCTION create_default_permissions()
RETURNS TRIGGER AS $$
DECLARE
  pages text[] := ARRAY['home', 'health', 'finance', 'productivity', 'devices', 'settings'];
  default_level text;
  p text;
BEGIN
  -- æ ¹æ“šè§’è‰²æ±ºå®šé è¨­æ¬Šé™
  IF NEW.role IN ('owner', 'admin') THEN
    default_level := 'full';
  ELSE
    default_level := 'close';
  END IF;

  -- ç‚ºæ¯å€‹é é¢å»ºç«‹æ¬Šé™è¨˜éŒ„
  FOREACH p IN ARRAY pages LOOP
    INSERT INTO page_permissions (household_member_id, page, access_level)
    VALUES (NEW.id, p, default_level)
    ON CONFLICT DO NOTHING;
  END LOOP;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_create_default_permissions
AFTER INSERT ON household_members
FOR EACH ROW
EXECUTE FUNCTION create_default_permissions();
```

---

## 8. API è¨­è¨ˆ

### 8.1 å ´åŸŸç›¸é—œ

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/sites` | å–å¾—ä½¿ç”¨è€…çš„æ‰€æœ‰å ´åŸŸ |
| POST | `/api/sites` | å»ºç«‹æ–°å ´åŸŸ |
| GET | `/api/sites/:id` | å–å¾—å ´åŸŸè©³æƒ… |
| PUT | `/api/sites/:id` | æ›´æ–°å ´åŸŸè¨­å®š |
| DELETE | `/api/sites/:id` | åˆªé™¤å ´åŸŸï¼ˆåƒ… ownerï¼‰ |

### 8.2 æˆå“¡ç›¸é—œ

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/sites/:id/members` | å–å¾—å ´åŸŸæˆå“¡åˆ—è¡¨ |
| POST | `/api/sites/:id/invitations` | ç™¼é€é‚€è«‹ |
| DELETE | `/api/sites/:id/members/:memberId` | ç§»é™¤æˆå“¡ |
| PUT | `/api/sites/:id/members/:memberId/role` | è®Šæ›´æˆå“¡è§’è‰² |

### 8.3 æ¬Šé™ç›¸é—œ

| æ–¹æ³• | ç«¯é» | èªªæ˜ |
|------|------|------|
| GET | `/api/sites/:id/permissions` | å–å¾—æ¬Šé™çŸ©é™£ |
| PUT | `/api/sites/:id/permissions/:memberId` | æ›´æ–°æˆå“¡æ¬Šé™ |
| GET | `/api/my-permissions` | å–å¾—ç•¶å‰ä½¿ç”¨è€…åœ¨ç•¶å‰å ´åŸŸçš„æ¬Šé™ |

---

## 9. å‰ç«¯å¯¦ä½œ

### 9.1 æ–°å¢çµ„ä»¶

| çµ„ä»¶ | è·¯å¾‘ | èªªæ˜ |
|------|------|------|
| `SiteSwitcher` | `src/core/components/site-switcher.tsx` | å ´åŸŸåˆ‡æ›ä¸‹æ‹‰é¸å–® |
| `PermissionMatrix` | `src/modules/settings/components/permission-matrix.tsx` | æ¬Šé™çŸ©é™£è¡¨æ ¼ï¼ˆå·²å­˜åœ¨ï¼Œéœ€æ›´æ–°ï¼‰ |
| `InviteMemberDialog` | `src/modules/settings/components/invite-member-dialog.tsx` | é‚€è«‹æˆå“¡å°è©±æ¡†ï¼ˆéœ€æ›´æ–°ï¼‰ |
| `RoleSelector` | `src/modules/settings/components/role-selector.tsx` | è§’è‰²é¸æ“‡å™¨ |

### 9.2 æ–°å¢ Hooks

| Hook | èªªæ˜ |
|------|------|
| `useSites()` | å–å¾—/ç®¡ç†ä½¿ç”¨è€…çš„æ‰€æœ‰å ´åŸŸ |
| `useCurrentSite()` | å–å¾—/åˆ‡æ›ç•¶å‰å ´åŸŸ |
| `usePermission(page)` | å–å¾—ç•¶å‰ä½¿ç”¨è€…åœ¨æŒ‡å®šé é¢çš„æ¬Šé™ |
| `useSiteMembers()` | å–å¾—ç•¶å‰å ´åŸŸçš„æˆå“¡åˆ—è¡¨ |

### 9.3 ç‹€æ…‹ç®¡ç†

```typescript
// Zustand store
interface SiteStore {
  // å ´åŸŸ
  sites: Site[];
  currentSiteId: string | null;

  // æ¬Šé™
  myPermissions: Record<PageId, AccessLevel>;

  // Actions
  fetchSites: () => Promise<void>;
  switchSite: (siteId: string) => void;
  createSite: (name: string) => Promise<Site>;

  // æ¬Šé™ Actions
  fetchMyPermissions: () => Promise<void>;
  canView: (page: PageId) => boolean;
  canEdit: (page: PageId) => boolean;
  canManage: (page: PageId) => boolean;
}
```

---

## 10. æ¬Šé™æª¢æŸ¥æµç¨‹

### 10.1 Middleware æª¢æŸ¥

```typescript
// middleware.ts
const pageRouteMap = {
  '/health': 'health',
  '/finance': 'finance',
  '/productivity': 'productivity',
  '/devices': 'devices',
  '/settings': 'settings',
};

// æª¢æŸ¥è·¯ç”±æ˜¯å¦éœ€è¦æ¬Šé™
const page = pageRouteMap[pathname];
if (page) {
  const permission = await getUserPermission(userId, siteId, page);

  if (permission === 'close') {
    return NextResponse.redirect('/dashboard?error=no_access');
  }
}
```

### 10.2 UI çµ„ä»¶æª¢æŸ¥

```tsx
// ä½¿ç”¨ç¯„ä¾‹
function FinancePage() {
  const { canView, canEdit, canManage } = usePermission('finance');

  if (!canView) return <NoAccessPage />;

  return (
    <div>
      {/* é¡¯ç¤ºè³‡æ–™ */}
      <TransactionList />

      {/* æœ‰é™æ¬Šé™ï¼šå¯æ–°å¢ */}
      {canEdit && <AddTransactionButton />}

      {/* å®Œæ•´æ¬Šé™ï¼šå¯ç®¡ç† */}
      {canManage && <ManageCategoriesButton />}
    </div>
  );
}
```

---

## 11. i18n æ›´æ–°

### 11.1 æ–°å¢ç¿»è­¯éµ

```json
{
  "site": {
    "title": "å ´åŸŸ",
    "mySites": "æˆ‘çš„å ´åŸŸ",
    "createSite": "å»ºç«‹æ–°å ´åŸŸ",
    "switchSite": "åˆ‡æ›å ´åŸŸ",
    "siteSettings": "å ´åŸŸè¨­å®š",
    "deleteSite": "åˆªé™¤å ´åŸŸ",
    "deleteSiteConfirm": "ç¢ºå®šè¦åˆªé™¤æ­¤å ´åŸŸå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚"
  },
  "roles": {
    "owner": "æ“æœ‰è€…",
    "admin": "ç®¡ç†å“¡",
    "member": "ä½¿ç”¨è€…"
  },
  "permissions": {
    "close": "é—œé–‰",
    "view": "æª¢è¦–",
    "limited": "æœ‰é™",
    "full": "ç·¨è¼¯",
    "closeDesc": "ç„¡æ³•å­˜å–æ­¤é é¢",
    "viewDesc": "åªèƒ½æŸ¥çœ‹ï¼Œä¸èƒ½ä¿®æ”¹",
    "limitedDesc": "å¯æ–°å¢/ç·¨è¼¯ç´€éŒ„ï¼Œä¸èƒ½ç®¡ç†è¨­å®š",
    "fullDesc": "å®Œæ•´æ¬Šé™ï¼ŒåŒ…å«æ‰€æœ‰åŠŸèƒ½"
  },
  "invite": {
    "title": "é‚€è«‹æˆå“¡",
    "subtitle": "ç™¼é€é‚€è«‹åŠ å…¥æ‚¨çš„å ´åŸŸ",
    "email": "é›»å­éƒµä»¶åœ°å€",
    "role": "æˆå“¡è§’è‰²",
    "defaultAccess": "é è¨­å­˜å–ç­‰ç´š",
    "defaultAccessHint": "åˆå§‹å¥—ç”¨æ–¼æ‰€æœ‰é é¢ï¼ŒåŠ å…¥å¾Œå¯é€é è‡ªè¨‚ã€‚",
    "send": "ç™¼é€é‚€è«‹",
    "cancel": "å–æ¶ˆ"
  }
}
```

---

## 12. å¯¦ä½œéšæ®µ

### Phase 1: åŸºç¤æ¶æ§‹ (1-2 å¤©)
- [ ] è³‡æ–™åº« migrationï¼šæ›´æ–° `page_permissions` ç´„æŸ
- [ ] å»ºç«‹ `create_default_permissions` è§¸ç™¼å™¨
- [ ] æ›´æ–° i18n ç¿»è­¯æª”ï¼ˆç¶²ç«™ â†’ å ´åŸŸï¼‰

### Phase 2: å ´åŸŸåˆ‡æ› (1-2 å¤©)
- [ ] å»ºç«‹ `useSites` hook
- [ ] å»ºç«‹ `SiteSwitcher` çµ„ä»¶
- [ ] æ•´åˆåˆ°å´é‚Šæ¬„/å°è¦½åˆ—
- [ ] å»ºç«‹æ–°å ´åŸŸåŠŸèƒ½

### Phase 3: æ¬Šé™ç³»çµ± (2-3 å¤©)
- [ ] æ›´æ–° `usePermission` hook
- [ ] æ›´æ–° `PermissionMatrix` çµ„ä»¶ï¼ˆæ–°å¢é é¢ã€æ–°å¢æœ‰é™æ¬Šé™ï¼‰
- [ ] æ›´æ–° middleware æ¬Šé™æª¢æŸ¥
- [ ] æ›´æ–°å„é é¢çš„æ¬Šé™æª¢æŸ¥

### Phase 4: é‚€è«‹æµç¨‹ (1-2 å¤©)
- [ ] æ›´æ–° `InviteMemberDialog`ï¼ˆæ–°å¢è§’è‰²é¸æ“‡ï¼‰
- [ ] æ›´æ–°é‚€è«‹ APIï¼ˆæ”¯æ´è§’è‰²å’Œé è¨­æ¬Šé™ï¼‰
- [ ] å»ºç«‹é‚€è«‹æ¥å—æµç¨‹

### Phase 5: æ¸¬è©¦èˆ‡å„ªåŒ– (1 å¤©)
- [ ] ç«¯å°ç«¯æ¸¬è©¦
- [ ] æ¬Šé™é‚Šç•Œæ¸¬è©¦
- [ ] UI/UX å„ªåŒ–

---

## 13. æ³¨æ„äº‹é …

### 13.1 å‘å¾Œç›¸å®¹
- ç¾æœ‰ä½¿ç”¨è€…çš„å ´åŸŸè³‡æ–™ä¸å—å½±éŸ¿
- ç¾æœ‰ `household_members` ä¸­ `role = 'owner'` çš„æˆå“¡è‡ªå‹•ç²å¾—æ‰€æœ‰ `full` æ¬Šé™

### 13.2 å®‰å…¨è€ƒé‡
- æ‰€æœ‰æ¬Šé™æª¢æŸ¥å¿…é ˆåœ¨ä¼ºæœå™¨ç«¯åŸ·è¡Œ
- å‰ç«¯æ¬Šé™æª¢æŸ¥åƒ…ç”¨æ–¼ UI éš±è—ï¼Œä¸èƒ½ä½œç‚ºå®‰å…¨æ©Ÿåˆ¶
- æ•æ„Ÿæ“ä½œï¼ˆåˆªé™¤å ´åŸŸã€ç§»é™¤æˆå“¡ï¼‰éœ€è¦äºŒæ¬¡ç¢ºèª

### 13.3 æ•ˆèƒ½è€ƒé‡
- æ¬Šé™è³‡æ–™å¯å¿«å–åœ¨ Zustand store
- å ´åŸŸåˆ‡æ›æ™‚éœ€é‡æ–°è¼‰å…¥æ¬Šé™
- ä½¿ç”¨ optimistic update æå‡ UX

---

## 14. é™„éŒ„

### A. æ¬Šé™æª¢æŸ¥é€ŸæŸ¥è¡¨

| æ“ä½œ | éœ€è¦æ¬Šé™ |
|------|----------|
| æŸ¥çœ‹é é¢ | `view` ä»¥ä¸Š |
| æ–°å¢ç´€éŒ„ | `limited` ä»¥ä¸Š |
| ç·¨è¼¯ç´€éŒ„ | `limited` ä»¥ä¸Š |
| åˆªé™¤ç´€éŒ„ | `full` |
| ç®¡ç†é¡åˆ¥/å¸³æˆ¶ | `full` |
| ç®¡ç†æˆå“¡ | `admin` æˆ– `owner` |
| å ´åŸŸè¨­å®š | `admin` æˆ– `owner` |
| åˆªé™¤å ´åŸŸ | `owner` |

### B. ç¾æœ‰è³‡æ–™åº«è¡¨æ ¼é—œä¿‚

```
households (å ´åŸŸ)
    â”œâ”€â”€ household_members (æˆå“¡)
    â”‚       â””â”€â”€ page_permissions (é é¢æ¬Šé™)
    â”œâ”€â”€ site_invitations (é‚€è«‹)
    â”œâ”€â”€ finance_* (è²¡å‹™ç›¸é—œ)
    â”œâ”€â”€ tasks (ä»»å‹™)
    â”œâ”€â”€ notes (ç­†è¨˜)
    â”œâ”€â”€ events (æ—¥æ›†)
    â””â”€â”€ home_devices (è¨­å‚™)
```
